# PNG文件格式解析

## PNG的文件结构

### PNG的文件头

PNG文件的文件头是固定的

`十进制数：137 80 78 71 13 10 26 10`

`十六进制数：89 50 4E 47 0D 0A 1A 0A`

十六进制数的第一个字节为0x89，超出了ASCII字符的范围，这是为了避免某些软件将PNG文件当做文本文件来处理

一个标准的PNG文件结构如下

`PNG文件标志`+`PNG数据块`+...+`PNG数据块`

### PNG数据块（Chunk）

PNG定义了两种类型的数据块：`关键数据块（critical chunk）`，`辅助数据块（ancillary chunks）`

关键数据块是必要的数据块，辅助数据块是可选数据块

每个数据块都由4个域组成：`Length（长度）`，`Chunk Type Code（数据块类型码）`，`Chunk Data（数据块实际内容）`，`CRC（循环冗余检测）`

==其中，CRC（循环冗余检测）域中的值是由Chunk Type Code（数据块类型码）和Chunk Data（数据块实际内容）域中的值计算得到的，可以看做是一种校验码。==

#### 关键数据块

关键数据块中包含四个标准数据块

##### 文件头数据块（IHDR）

它包含有PNG文件中存储的图像数据的基本信息，并要作为第一个数据块出现在PNG数据流中，并且一个PNG数据流中有且只能有一个文件头数据块

文件头数据块共13个字节，结构如下

Width（4字节）：图像宽度，以像素为单位 
Height（4字节）：图像高度，以像素为单位
Bit depth（1字节）：图像深度，索引彩色图像为1,2,4或8，灰度图像为1,2,4,8或16，真彩色图像为8或16
Colortype（1字节）：颜色类型，灰度图像为1,2,4,8或16，真彩色图像为8或16，索引彩色图像为1,2,4或8，带α通道数据的灰度图像为8或16，带α通道数据的真彩色图像为8或16
Compression method（1字节）：压缩方法
Filter method（1字节）：滤波器方法
Interface method（1字节）：隔行扫描方法

##### 调色板数据块（PLTE）

它包含有与索引彩色图像((indexed-color image))相关的彩色变换数据，它仅与索引彩色图像有关，而且要放在图像数据块(image data chunk)之前。真彩色的PNG数据流也可以有调色板数据块，目的是便于非真彩色显示程序用它来量化图像数据，从而显示该图像


##### 图像数据块（IDAT）

它存储实际的数据，在数据流中可包含多个连续顺序的图像数据块
IDAT存放着图像真正的数据信息，因此，如果能够了解IDAT的结构，我们就可以很方便的生成PNG图像

##### 图像结束数据（IEND）

它用来标记PNG文件或者数据流已经结束，并且必须要放在文件的尾部

如果我们仔细观察PNG文件，我们会发现，文件的结尾12个字符看起来总应该是这样的：

```
 00 00 00 00 49 45 4E 44 AE 42 60 82 
```

不难明白，由于数据块结构的定义，IEND数据块的长度总是0（00 00 00 00，除非人为加入信息），数据标识总是IEND（49 45 4E 44），因此，CRC码也总是AE 42 60 82。

最后，除了表示数据块开始的IHDR必须放在最前面， 表示PNG文件结束的IEND数据块放在最后面之外，其他数据块的存放顺序没有限制。

#### 辅助数据块

（比较杂，不需要全部了解透）

PNG文件格式规范制定的10个辅助数据块是：

1. 背景颜色数据块bKGD(background color)。
2. 基色和白色度数据块cHRM(primary chromaticities and white point)。所谓白色度是指当R＝G＝B＝最大值时在显示器上产生的白色度。
3. 图像γ数据块gAMA(image gamma)。
4. 图像直方图数据块hIST(image histogram)。
5. 物理像素尺寸数据块pHYs(physical pixel dimensions)。
6. 样本有效位数据块sBIT(significant bits)。
7. 文本信息数据块tEXt(textual data)。
8. 图像最后修改时间数据块tIME (image last-modification time)。
9. 图像透明数据块tRNS (transparency)。
10. 压缩文本数据块zTXt (compressed textual data)。